<!DOCTYPE html>
<html>
	<head>
		<title>Movie Night Bracket Maker</title>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://underscorejs.org/underscore-min.js"></script>
		<script>
			$(document).ready(function() {
				let currentBracket = [];
				let bracketData = [];
				let totalRounds = 0;
				let currentRound = 1;
				
				// Function to get next power of 2
				function getNextPowerOfTwo(n) {
					if (n <= 2) return 2;
					if (n <= 4) return 4;
					if (n <= 8) return 8;
					if (n <= 16) return 16;
					if (n <= 32) return 32;
					if (n <= 64) return 64;
					return 64; // Max supported
				}

				// Function to parse movie list
				function parseMovieList(text) {
					return text.split('\n')
						.map(line => line.trim())
						.filter(line => line.length > 0);
				}

				// Function to shuffle array
				function shuffle(array) {
					const shuffled = [...array];
					for (let i = shuffled.length - 1; i > 0; i--) {
						const j = Math.floor(Math.random() * (i + 1));
						[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
					}
					return shuffled;
				}

				// Function to create bracket structure
				function createBracketStructure(movies) {
					const bracketSize = getNextPowerOfTwo(movies.length);
					const rounds = Math.log2(bracketSize);
					totalRounds = rounds;
					
					// Pad with byes if needed
					const paddedMovies = [...movies];
					while (paddedMovies.length < bracketSize) {
						paddedMovies.push('BYE');
					}

					// Create bracket structure
					const bracket = [];
					let currentRoundMatches = bracketSize / 2;
					let matchId = 1;

					for (let round = 1; round <= rounds; round++) {
						bracket[round] = [];
						for (let match = 0; match < currentRoundMatches; match++) {
							if (round === 1) {
								// First round - populate with actual movies
								bracket[round].push({
									id: matchId++,
									round: round,
									team1: paddedMovies[match * 2],
									team2: paddedMovies[match * 2 + 1],
									winner: '',
									team1Votes: 0,
									team2Votes: 0
								});
							} else {
								// Later rounds - empty for now
								bracket[round].push({
									id: matchId++,
									round: round,
									team1: '',
									team2: '',
									winner: '',
									team1Votes: 0,
									team2Votes: 0
								});
							}
						}
						currentRoundMatches /= 2;
					}

					return bracket;
				}

				// Function to render bracket
				function renderBracket(skipByes = false) {
					const container = $('#bracket-container');
					container.empty();

					if (bracketData.length === 0) return;

					for (let round = 1; round <= totalRounds; round++) {
						const roundDiv = $(`<div class="round" data-round="${round}"></div>`);
						const roundTitle = $(`<h3>Round ${round}${round === totalRounds ? ' - FINAL' : ''}</h3>`);
						roundDiv.append(roundTitle);

						bracketData[round].forEach(match => {
							// Don't highlight BYEs as winners, and don't highlight wins against BYEs
							const team1IsBye = match.team1 === 'BYE';
							const team2IsBye = match.team2 === 'BYE';
							const isAgainstBye = team1IsBye || team2IsBye;
							const shouldHighlightTeam1 = match.winner && match.winner === match.team1 && !team1IsBye && !isAgainstBye;
							const shouldHighlightTeam2 = match.winner && match.winner === match.team2 && !team2IsBye && !isAgainstBye;
							
							const matchDiv = $(`
								<div class="match" data-match-id="${match.id}">
									<div class="team-container">
										<div class="team team1 ${shouldHighlightTeam1 ? 'winner' : ''}">
											<input type="text" class="team-input" value="${match.team1}" data-team="1">
											<button class="vote-btn" data-team="1" ${match.team1 === 'BYE' || match.winner ? 'disabled' : ''}>
												✓
											</button>
										</div>
										<div class="vs">VS</div>
										<div class="team team2 ${shouldHighlightTeam2 ? 'winner' : ''}">
											<input type="text" class="team-input" value="${match.team2}" data-team="2">
											<button class="vote-btn" data-team="2" ${match.team2 === 'BYE' || match.winner ? 'disabled' : ''}>
												✓
											</button>
										</div>
									</div>
								</div>
							`);
							roundDiv.append(matchDiv);
						});

						container.append(roundDiv);
					}

					// Handle BYE advancement automatically when needed
					if (!skipByes) {
						// Only process BYEs if not currently processing other operations
						if (!isProcessingBracket) {
							handleByes();
						}
					}
				}

				// Function to handle BYE matches
				function handleByes() {
					let hasChanges = true;
					let iterations = 0;
					const maxIterations = 15; // Safety limit
					
					while (hasChanges && iterations < maxIterations) {
						hasChanges = false;
						iterations++;
						
						for (let round = 1; round <= totalRounds; round++) {
							if (!bracketData[round]) continue; // Safety check
							
							bracketData[round].forEach(match => {
								if (!match || match.winner) return; // Only process matches without winners
								
								const team1Valid = match.team1 && match.team1 !== '' && match.team1 !== null;
								const team2Valid = match.team2 && match.team2 !== '' && match.team2 !== null;
								const team1IsBye = match.team1 === 'BYE';
								const team2IsBye = match.team2 === 'BYE';
								
								// Handle different BYE scenarios
								if (team1IsBye && team2Valid && !team2IsBye) {
									// Team 2 wins against BYE
									selectWinnerInternal(match, round, match.team2);
									hasChanges = true;
								} else if (team2IsBye && team1Valid && !team1IsBye) {
									// Team 1 wins against BYE
									selectWinnerInternal(match, round, match.team1);
									hasChanges = true;
								} else if (team1IsBye && team2IsBye) {
									// Both are BYEs - BYE advances
									selectWinnerInternal(match, round, 'BYE');
									hasChanges = true;
								}
							});
						}
					}
					
					if (iterations >= maxIterations) {
						console.warn('BYE handling reached maximum iterations, stopping to prevent infinite loop');
					}
				}

				// Internal function to select winner without re-rendering
				function selectWinnerInternal(match, roundNum, winner) {
					if (!match || match.winner || !winner) return; // Safety checks
					
					match.winner = winner;

					// Advance winner to next round
					if (roundNum < totalRounds) {
						const nextRound = roundNum + 1;
						const currentRoundMatches = bracketData[roundNum];
						
						if (!currentRoundMatches || !bracketData[nextRound]) return; // Safety checks
						
						const matchIndex = currentRoundMatches.indexOf(match);
						if (matchIndex === -1) return; // Safety check
						
						const nextMatchIndex = Math.floor(matchIndex / 2);
						const nextMatch = bracketData[nextRound][nextMatchIndex];
						
						if (!nextMatch) return; // Safety check
						
						const teamPosition = matchIndex % 2;

						// Update the next match with the winner
						if (teamPosition === 0) {
							// Winner goes to team1 position in next match
							if (nextMatch.team1 !== winner) {
								nextMatch.team1 = winner;
								// Clear winner if teams change to allow new BYE processing
								if (nextMatch.winner) {
									nextMatch.winner = '';
								}
							}
						} else {
							// Winner goes to team2 position in next match
							if (nextMatch.team2 !== winner) {
								nextMatch.team2 = winner;
								// Clear winner if teams change to allow new BYE processing
								if (nextMatch.winner) {
									nextMatch.winner = '';
								}
							}
						}
					}
				}

				// Global flag to prevent concurrent bracket operations
				let isProcessingBracket = false;

				// Function to select winner
				function selectWinner(matchId, winner) {
					if (!winner || winner.trim() === '' || isProcessingBracket) return; // Safety check
					
					isProcessingBracket = true;
					
					// Find and update the match
					let match = null;
					let roundNum = 0;
					
					for (let round = 1; round <= totalRounds; round++) {
						if (!bracketData[round]) continue; // Safety check
						const found = bracketData[round].find(m => m.id === matchId);
						if (found) {
							match = found;
							roundNum = round;
							break;
						}
					}

					if (!match || match.winner) {
						isProcessingBracket = false;
						return; // Safety checks
					}

					// Use internal function to avoid recursion
					selectWinnerInternal(match, roundNum, winner);

					// Check for tournament completion
					if (roundNum === totalRounds && winner && winner !== 'BYE') {
						showWinner(winner);
					}

					// Use requestAnimationFrame for smooth UI updates
					requestAnimationFrame(() => {
						renderBracket(true); // Skip BYE handling in render
						
						// Handle any new BYE scenarios that may have been created
						setTimeout(() => {
							handleByes();
							// Re-render to show BYE advancements
							renderBracket(true);
						}, 10);
						
						isProcessingBracket = false;
					});
				}

				// Function to show winner
				function showWinner(winner) {
					$('#winner-section .winner-name').text(winner);
					$('#winner-section').show();
				}

				// Function to hide winner
				function hideWinner() {
					$('#winner-section').hide();
					$('#winner-section .winner-name').text('');
				}

				// Event handlers
				$('#generate-bracket').on('click', function() {
					const movieText = $('#movie-list').val().trim();
					if (!movieText) {
						alert('Please enter some movies first!');
						return;
					}

					const movies = parseMovieList(movieText);
					if (movies.length < 2) {
						alert('Please enter at least 2 movies!');
						return;
					}

					if (movies.length > 64) {
						alert('Maximum 64 movies supported. Using first 64.');
						movies.splice(64);
					}

					// Complete cleanup - remove all existing elements and data
					hideWinner();
					currentBracket = [];
					bracketData = [];
					totalRounds = 0;
					isProcessingBracket = false; // Reset processing flag
					$('#bracket-container').empty();

					// Small delay to ensure cleanup completes
					setTimeout(() => {
						// Create new bracket
						currentBracket = shuffle(movies);
						bracketData = createBracketStructure(currentBracket);
						
						// Handle BYEs immediately after bracket creation
						handleByes();
						
						// Render bracket with BYEs already processed
						renderBracket(true);
						
						$('#controls').show();
						$('#bracket-section').show();
					}, 10);
				});

				$('#shuffle-bracket').on('click', function() {
					if (currentBracket.length === 0) return;
					
					// Clear winner display
					hideWinner();
					isProcessingBracket = false; // Reset processing flag
					
					// Small delay to ensure cleanup
					setTimeout(() => {
						const shuffledMovies = shuffle(currentBracket);
						bracketData = createBracketStructure(shuffledMovies);
						
						// Handle BYEs immediately after bracket creation
						handleByes();
						
						// Render bracket with BYEs already processed
						renderBracket(true);
					}, 10);
				});



				// Handle vote button clicks
				$(document).on('click', '.vote-btn', function() {
					const button = $(this);
					
					// Prevent multiple rapid clicks and concurrent processing
					if (button.prop('disabled') || button.data('processing') || isProcessingBracket) return;
					
					button.data('processing', true);
					button.prop('disabled', true); // Temporarily disable the button
					
					const matchDiv = button.closest('.match');
					const matchId = parseInt(matchDiv.data('match-id'));
					const teamNum = button.data('team');
					const teamInput = button.siblings('.team-input');
					const winner = teamInput.val().trim();
					
					if (!winner || winner === 'BYE') {
						button.data('processing', false);
						button.prop('disabled', false);
						return;
					}
					
					selectWinner(matchId, winner);
					
					// Reset processing flag after render is complete
					setTimeout(() => {
						button.data('processing', false);
						// Don't re-enable if the button should stay disabled (winner selected)
						if (!button.closest('.match').find('.team-input').hasClass('winner')) {
							button.prop('disabled', false);
						}
					}, 200);
				});

				// Handle team input changes
				$(document).on('input', '.team-input', function() {
					const matchDiv = $(this).closest('.match');
					const matchId = parseInt(matchDiv.data('match-id'));
					const teamNum = $(this).data('team');
					const newValue = $(this).val().trim();
					
					// Find and update the match data
					for (let round = 1; round <= totalRounds; round++) {
						const match = bracketData[round].find(m => m.id === matchId);
						if (match) {
							if (teamNum === '1') {
								match.team1 = newValue;
							} else {
								match.team2 = newValue;
							}
							break;
						}
					}
				});

				// Handle new tournament button
				$(document).on('click', '#new-tournament', function() {
					hideWinner();
					currentBracket = [];
					bracketData = [];
					totalRounds = 0;
					isProcessingBracket = false; // Reset processing flag
					$('#bracket-container').empty();
					$('#controls').hide();
					$('#bracket-section').hide();
					$('#movie-list').val('');
				});

			});
		</script>
		<style type="text/css">
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
				background: #0d1117;
				color: #e6edf3;
				min-height: 100vh;
				padding: 40px 20px;
				line-height: 1.6;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
			}

			h1 {
				text-align: center;
				color: #f0f6fc;
				font-size: 2.5rem;
				font-weight: 300;
				margin-bottom: 3rem;
				letter-spacing: -0.5px;
			}

			.setup-section {
				padding: 2rem 0;
				margin-bottom: 3rem;
			}

			.setup-section h2 {
				margin-bottom: 1.5rem;
				color: #f0f6fc;
				font-weight: 400;
				font-size: 1.5rem;
			}

			.input-group {
				margin-bottom: 1.5rem;
			}

			label {
				display: block;
				margin-bottom: 0.75rem;
				font-weight: 400;
				color: #8b949e;
				font-size: 0.95rem;
			}

			textarea {
				width: 100%;
				min-height: 150px;
				padding: 1rem;
				border: 2px solid #30363d;
				border-radius: 8px;
				font-family: inherit;
				font-size: 1rem;
				resize: vertical;
				transition: all 0.2s ease;
				background: rgba(22, 27, 34, 0.8);
				color: #e6edf3;
			}

			textarea:focus {
				outline: none;
				border-color: #58a6ff;
				box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
				background: rgba(22, 27, 34, 1);
			}

			.button-group {
				display: flex;
				gap: 1rem;
				flex-wrap: wrap;
			}

			button {
				padding: 0.75rem 1.5rem;
				border: 1px solid #30363d;
				border-radius: 4px;
				font-size: 0.95rem;
				font-weight: 400;
				cursor: pointer;
				transition: all 0.2s ease;
				background: #21262d;
				color: #e6edf3;
			}

			.btn-primary {
				background: #238636;
				color: white;
				border-color: #238636;
			}

			.btn-secondary {
				background: #21262d;
				color: #e6edf3;
				border-color: #30363d;
			}

			button:hover {
				transform: translateY(-1px);
				box-shadow: 0 2px 8px rgba(0,0,0,0.3);
			}

			.btn-primary:hover {
				background: #2ea043;
				border-color: #2ea043;
			}

			.btn-secondary:hover {
				background: #30363d;
				border-color: #484f58;
			}

			button:disabled {
				background: #21262d;
				color: #6e7681;
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
				border-color: #21262d;
			}

			#controls {
				display: none;
			}

			#winner-section {
				text-align: center;
				margin: 3rem 0;
			}

			.winner-announcement {
				background: linear-gradient(135deg, #0d4f12, #238636);
				padding: 2rem;
				border-radius: 12px;
				border: 2px solid #2ea043;
				box-shadow: 0 8px 32px rgba(46, 160, 67, 0.3);
			}

			.winner-announcement h2 {
				color: #f0f6fc;
				font-size: 2rem;
				font-weight: 400;
				margin-bottom: 1rem;
			}

			.winner-name {
				font-size: 2.5rem;
				font-weight: 600;
				color: #ffffff;
				margin: 1rem 0;
				text-shadow: 0 2px 4px rgba(0,0,0,0.3);
			}

			.winner-announcement p {
				color: #c9d1d9;
				font-size: 1.1rem;
				margin-top: 1rem;
			}

			#bracket-section {
				display: none;
				margin-top: 3rem;
			}

			#bracket-container {
				display: flex;
				gap: 2rem;
				overflow-x: auto;
				padding: 1rem 0;
				position: relative;
			}

			.round {
				min-width: 300px;
				flex-shrink: 0;
				position: relative;
			}

			.round:not(:last-child)::after {
				content: '';
				position: absolute;
				top: 0;
				right: -1rem;
				width: 2rem;
				height: 100%;
				background: rgba(48, 54, 61, 0.3);
				z-index: 0;
				pointer-events: none;
			}

			.round h3 {
				text-align: center;
				margin-bottom: 1.5rem;
				padding: 0.75rem;
				background: #21262d;
				color: #f0f6fc;
				border-radius: 4px;
				font-size: 1rem;
				font-weight: 500;
				border: 1px solid #30363d;
			}

			.match {
				background: #0d1117;
				border: 1px solid #30363d;
				border-radius: 4px;
				padding: 1.25rem;
				margin-bottom: 1.5rem;
				transition: all 0.2s ease;
				position: relative;
			}

			.match:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(0,0,0,0.4);
				border-color: #484f58;
			}

			.match::after {
				content: '';
				position: absolute;
				top: 50%;
				right: -1.5rem;
				width: 1.5rem;
				height: 1px;
				background: #30363d;
				transform: translateY(-50%);
				z-index: 2;
			}

			.round:last-child .match::after {
				display: none;
			}

			/* Add bracket connector lines */
			.match::before {
				content: '';
				position: absolute;
				top: 50%;
				left: -1.5rem;
				width: 1.5rem;
				height: 1px;
				background: #30363d;
				transform: translateY(-50%);
				z-index: 2;
			}

			.round:first-child .match::before {
				display: none;
			}

			.team-container {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}

			.team {
				display: flex;
				align-items: center;
				gap: 1rem;
				padding: 0.75rem;
				border-radius: 4px;
				background: #161b22;
				border: 1px solid #30363d;
				transition: all 0.2s ease;
			}

			.team.winner {
				background: #0d4f12;
				border-color: #238636;
			}

			.vs {
				text-align: center;
				font-weight: 400;
				color: #8b949e;
				padding: 0.5rem;
				font-size: 0.9rem;
			}

			.team-input {
				flex: 1;
				padding: 0.5rem;
				border: 1px solid #30363d;
				border-radius: 3px;
				font-size: 0.95rem;
				font-weight: 400;
				transition: border-color 0.2s ease;
				background: #0d1117;
				color: #e6edf3;
			}

			.team-input:focus {
				outline: none;
				border-color: #58a6ff;
				box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
			}

			.team-input[readonly] {
				background: #21262d;
				color: #8b949e;
				cursor: not-allowed;
			}

			.team-input[value="BYE"] {
				background: #21262d;
				color: #8b949e;
			}

			.vote-btn {
				width: 24px;
				height: 24px;
				padding: 0;
				background: #238636;
				color: white;
				border: 1px solid #238636;
				border-radius: 3px;
				font-size: 0.8rem;
				font-weight: 400;
				cursor: pointer;
				transition: all 0.2s ease;
				display: flex;
				align-items: center;
				justify-content: center;
				flex-shrink: 0;
			}

			.vote-btn:hover:not(:disabled) {
				background: #2ea043;
				border-color: #2ea043;
			}

			.vote-btn:disabled {
				background: #6e7681;
				border-color: #6e7681;
				cursor: not-allowed;
				transform: none;
				box-shadow: none;
			}



			@media (max-width: 768px) {
				.container {
					padding: 0 10px;
				}
				
				h1 {
					font-size: 2rem;
				}
				
				.button-group {
					flex-direction: column;
				}
				
				button {
					padding: 1rem;
				}
				
				#bracket-container {
					flex-direction: column;
				}
				
				.round {
					min-width: 100%;
				}
				
				.team {
					flex-direction: column;
					gap: 0.5rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>🎬 Movie Night Bracket Maker</h1>
			
			<div class="setup-section">
				<h2>Setup Your Tournament</h2>
				<div class="input-group">
					<label for="movie-list">Enter your movies (one per line):</label>
					<textarea id="movie-list" placeholder="Enter your movies here, one per line..."></textarea>
				</div>
				
				<div class="button-group">
					<button id="generate-bracket" class="btn-primary">Generate Bracket</button>
					<div id="controls">
						<button id="shuffle-bracket" class="btn-secondary">Shuffle Movies</button>
					</div>
				</div>
			</div>

			<div id="winner-section" style="display: none;">
				<div class="winner-announcement">
					<h2>Tournament Winner</h2>
					<div class="winner-name"></div>
					<p>Your movie for tonight!</p>
					<button id="new-tournament" class="btn-primary" style="margin-top: 1rem;">New Tournament</button>
				</div>
			</div>

			<div id="bracket-section">
				<h2>Your Movie Tournament</h2>
				<div id="bracket-container"></div>
			</div>
		</div>
	</body>
</html>