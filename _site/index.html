<!DOCTYPE html>
<html>
	<head>
		<title>Tournament Bracket Generator</title>
		<link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
		<script defer src="https://pyscript.net/latest/pyscript.js"></script>
		<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
		<script src="http://underscorejs.org/underscore-min.js"></script>
		<script>
			$(document).on('ready', function() {
				
				var knownBrackets = [2,4,8,16,32], // brackets with "perfect" proportions (full fields, no byes)
				
					exampleTeams  = _.shuffle(["New Jersey Devils","New York Islanders","New York Rangers","Philadelphia Flyers","Pittsburgh Penguins","Boston Bruins","Buffalo Sabres","Montreal Canadiens","Ottawa Senators","Toronto Maple Leafs","Carolina Hurricanes","Florida Panthers","Tampa Bay Lightning","Washington Capitals","Winnipeg Jets","Chicago Blackhawks","Columbus Blue Jackets","Detroit Red Wings","Nashville Predators","St. Louis Blues","Calgary Flames","Colorado Avalanche","Edmonton Oilers","Minnesota Wild","Vancouver Canucks","Anaheim Ducks","Dallas Stars","Los Angeles Kings","Phoenix Coyotes","San Jose Sharks","Montreal Wanderers","Quebec Nordiques","Hartford Whalers"]), // because a bracket needs some teams!
					
					bracketCount = 0;
				
				function generateBracket(num_items){
					var closest 		= _.find(knownBrackets, function(k) { return k>=num_items; }),
						byes 			= closest-num_items;
					
					if(byes>0)	num_items = closest;

					var groupCount = _.findIndex(knownBrackets, function(x) {return x==closest;})+1;

					var brackets 	= [],
						round 		= 1,
						baseT 		= base/2,
						baseC 		= base/2,
						teamMark	= 0,
						nextInc		= base/2;
						
						
					for(i=1;i<=(base-1);i++) {
						var	baseR = i/baseT,
							isBye = false;
							
						if(byes>0 && (i%2!=0 || byes>=(baseT-i))) {
							isBye = true;
							byes--;
						}
						
						var last = _.map(_.filter(brackets, function(b) { return b.nextGame == i; }), function(b) { return {game:b.bracketNo,teams:b.teamnames}; });
						
						brackets.push({
							lastGames:	round==1 ? null : [last[0].game,last[1].game],
							nextGame:	nextInc+i>base-1?null:nextInc+i,
							bracketNo:	i,
							roundNo:	round,
							bye:		isBye 
						});
						teamMark+=2;
						if(i%2!=0)	nextInc--;
						while(baseR>=1) {
							round++;
							baseC/= 2;
							baseT = baseT + baseC;
							baseR = i/baseT;
						}
					}

					var group	= $('<div class="group'+(groupCount+1)+'" id="b'+bracketCount+'"></div>'),
						grouped = _.groupBy(struct, function(s) { return s.roundNo; });

					for(g=1;g<=groupCount;g++) {
						var round = $('<div class="r'+g+'"></div>');
						_.each(grouped[g], function(gg) {
							if(gg.bye)
								round.append('<div></div>');
							else
								round.append('<div><div class="bracketbox"><span class="info"></span><button>Vote</button><span class="teama'+gg.id+'"><input type="text" class="top-team"></span><button>Vote</button><span class="teamb"><input type="text" class="bot-team"></span></div></div>');
						});
						group.append(round);
					}
					group.append('<div class="r'+(groupCount+1)+'"><div class="final"><div class="bracketbox"><button>Vote</button><span class="teamc"><input type="text" class="final-team"></span></div></div></div>');
					$('#brackets').append(group);
					
					bracketCount++;
					$('html,body').animate({
						scrollTop: $("#b"+(bracketCount-1)).offset().top
					});
				}
				/*
				 * Build our bracket "model"
				 */
				function getBracket(base) {
				
					var closest 		= _.find(knownBrackets, function(k) { return k>=base; }),
						byes 			= closest-base;
						
					if(byes>0)	base = closest;
				
					var brackets 	= [],
						round 		= 1,
						baseT 		= base/2,
						baseC 		= base/2,
						teamMark	= 0,
						nextInc		= base/2;
						
					for(i=1;i<=(base-1);i++) {
						var	baseR = i/baseT,
							isBye = false;
							
						if(byes>0 && (i%2!=0 || byes>=(baseT-i))) {
							isBye = true;
							byes--;
						}
						
						var last = _.map(_.filter(brackets, function(b) { return b.nextGame == i; }), function(b) { return {game:b.bracketNo,teams:b.teamnames}; });
						
						brackets.push({
							lastGames:	round==1 ? null : [last[0].game,last[1].game],
							nextGame:	nextInc+i>base-1?null:nextInc+i,
							teamnames:	round==1 ? [exampleTeams[teamMark],exampleTeams[teamMark+1]] : [last[0].teams[_.random(1)],last[1].teams[_.random(1)]],
							bracketNo:	i,
							roundNo:	round,
							bye:		isBye
						});
						teamMark+=2;
						if(i%2!=0)	nextInc--;
						while(baseR>=1) {
							round++;
							baseC/= 2;
							baseT = baseT + baseC;
							baseR = i/baseT;
						}
					}
					
					renderBrackets(brackets);
				}
				
				/*
				 * Inject our brackets
				 */
				function renderBrackets(struct) {
					var groupCount	= _.uniq(_.map(struct, function(s) { return s.roundNo; })).length;
					
					var group	= $('<div class="group'+(groupCount+1)+'" id="b'+bracketCount+'"></div>'),
						grouped = _.groupBy(struct, function(s) { return s.roundNo; });

					for(g=1;g<=groupCount;g++) {
						var round = $('<div class="r'+g+'"></div>');
						_.each(grouped[g], function(gg) {
							if(gg.bye)
								round.append('<div></div>');
							else
								round.append('<div><div class="bracketbox"><span class="info"></span><button>Vote</button><span class="teama"><input type="text" class="top-team"></span><button>Vote</button><span class="teamb"><input type="text" class="bot-team"></span></div></div>');
						});
						group.append(round);
					}
					group.append('<div class="r'+(groupCount+1)+'"><div class="final"><div class="bracketbox"><button>Vote</button><span class="teamc"><input type="text" class="final-team"></span></div></div></div>');
					$('#brackets').append(group);
					
					bracketCount++;
					$('html,body').animate({
						scrollTop: $("#b"+(bracketCount-1)).offset().top
					});
				}
				
				$('#add').on('click', function() {
					var opts = parseInt(prompt('Bracket size (number of teams):',32));
					
					if(!_.isNaN(opts) && opts <= _.last(knownBrackets))
						getBracket(opts);
					else
						alert('The bracket size you specified is not currently supported.');
				});
				
			});
		</script>
		<style type="text/css">
			body {
				color: #eee;
				background: #121212;
			}
			a {
				color: #809fff;
			}
			p {
				font-family: "Courier New";
				font-weight: bolder;
				font-size: 10vw;
				text-align: center;
			}
			input {
				font-size: 25px;
				background: #242424;
				color: #eee;
				width: 100%;
			}
			button {
				display: none;
				float: right;
				border-radius: 5px;
				background-color: #C4F1BE;
			}
			html, body, .brackets {
				width: 100%;
				min-height: 100%;
				font-family: "Arial", sans-serif;
			}

			.metroBtn {
				background-color: #7C809B;
				color: #fff;
				font-size: 2vw;
				padding: 40px;
				margin: 0;
				position: absolute;
				left: 50%;
				top: 50%;
				-ms-transform: translate(-50%, 90%);
				transform: translate(-50%, 90%);
				margin-bottom: 50px;
				cursor: pointer;
				border-radius: 15px;
			}
			span {
				display:block;
				width:90%;
				padding-right:5px;
			}
			.brackets > div {
				vertical-align: top;
				clear: both;
			}
			.brackets > div > div {
				float: left;
				height: 100%;
			}
			.brackets > div > div > div {
				margin: 70px 0;
			}
			.brackets div.bracketbox {
				position: relative;
				width: 100%; height: 100%;
				border-top: 3px solid #A2C3A4;
				border-right: 3px solid #A2C3A4;
				border-bottom: 3px solid #A2C3A4;
			}
			.brackets div.bracketbox > span.info {
				position: absolute;
				top: 25%;
				left: 25%;
				color: #BBB;
			}
			.brackets div.bracketbox > span {
				position: absolute;
				left: 5px;
			}
			.brackets div.bracketbox > span.teama {
				top: -39px;
			}
			.brackets div.bracketbox > span.teamb {
				bottom: 1px;
			}
			.brackets div.bracketbox > span.teamc {
				bottom: 1px;
			}
			.brackets > .group2 {
				height: 260px;
			}
			.brackets > .group2 > div {
				width: 49%;
			}
			.brackets > .group3 {
				height: 320px;
			}
			.brackets > .group3 > div {
				width: 32.7%;
			}
			.brackets > .group4 > div {
				width: 24.5%;
			}
			.brackets > .group5 > div {
				width: 19.6%;
			}
			.brackets > .group6 {
				height: 2500px;
			}
			.brackets > .group6 > div {
				width: 16.3%;
			}
			.brackets > div > .r1 > div {
				height: 80px;
			}
			.brackets > div > .r2 > div {
				margin: 110px 0 150px 0;
				height: 150px;
			}
			.brackets > div > .r3 > div {
				margin: 185px 0 300px 0;
				height: 300px;
			}
			.brackets > div > .r4 > div {
				margin: 335px 0 600px 0;
				height: 600px;
			}
			.brackets > div > .r5 > div {
				margin: 635px 0 0 0;
				height: 1200px;
			}
			.brackets > div > .r6 > div {
				margin: 1235px 0 0 0;
			}
			.brackets div.final > div.bracketbox {
				border-top: 0px;
				border-right: 0px;
				height: 0px;
			}
			.brackets > div > .r4 > div.drop {
				height: 180px;
				margin-bottom: 0px;
			}
			.brackets > div > .r5 > div.final.drop {
				margin-top: 345px;
				margin-bottom: 0px;
				height: 1px;
			}
			.brackets > div > div > div:last-of-type {
				margin-bottom: 0px;
			}
		</style>
	</head>
	<body>
		<p>Movie Night Bracket Maker</p>
		<div><div id="add" class="metroBtn">Add Bracket</div></div>
		<div class="brackets" id="brackets">
		</div>
	</body>
</html>